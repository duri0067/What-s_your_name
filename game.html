<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>본격 어색함 방지 게임 : 너의 이름은 (최적화 버전)</title>

  <style>
    /* 로컬 픽셀 폰트 */
    @font-face{
      font-family:"ArcadePixel";
      src: url("PressStart2P.ttf") format("truetype");
      font-display: swap;
    }

    :root{
      --ink:#1a1a1a; --bg0:#101018; --bg1:#1b2230; --bg2:#252f45;
      --accent:#00ffc3; --accent2:#ffd400; --accent3:#ff5b5b;
      --panel:#121a28; --panel-br:#0a101b; --white:#f6f7ff; --pink:#ff9bd3;
      --gold:#ffd400; --blue:#47b0ff; --green:#00ffc3; --silver:#cfd6e1; --gray:#7f8da3;
    }

    *{ box-sizing:border-box; image-rendering: pixelated; }
    html,body{ height:100% }
    body{
      margin:0; color:var(--white);
      font-family:"ArcadePixel", system-ui, -apple-system, Segoe UI, Arial, sans-serif;
      background: linear-gradient(180deg, var(--bg0), var(--bg1));
      letter-spacing:.5px; text-align:center; overflow:hidden;
    }
    /* CRT 스캔라인 */
    body::after{
      content:""; position:fixed; inset:0; pointer-events:none;
      background-image: linear-gradient(rgba(0,0,0,.18) 50%, rgba(0,0,0,0) 50%);
      background-size:100% 4px; mix-blend-mode:overlay;
    }

    h1{
      margin:22px 8px 10px; font-size:32px; line-height:1.4;
      color:var(--accent2);
      text-shadow: 0 3px 0 var(--ink), 0 0 16px rgba(255,212,0,.55);
    }

    /* HUD */
    #hud{
      display:flex; justify-content:center; gap:18px;
      width:max-content; margin:12px auto 16px;
      padding:14px 18px; background:var(--panel);
      border:6px solid var(--panel-br);
      box-shadow: 0 5px 0 #000, inset 0 -5px 0 rgba(0,0,0,.2);
    }
    .hud-item{
      display:flex; align-items:center; gap:10px;
      min-width:240px; padding:12px 14px; font-size:18px;
      background:var(--bg2);
      border:6px solid var(--ink);
      box-shadow: 0 5px 0 #000; color:#b9c8ff;
    }
    .hud-item b{ color:var(--white); font-size:20px }
    #score b{ color:var(--accent) } #timer b{ color:var(--accent2) } #combo b{ color:var(--pink) }
    .icon{ width:28px; height:28px; flex:0 0 28px; image-rendering: pixelated; }

    /* LIFE HUD */
    #lifeBox{ display:flex; flex-direction:column; gap:6px; }
    #lifeText{ font-size:16px; color:#ffc6c6 }
    .lifeBar{
      position:relative; width:260px; height:22px;
      background:#2b1a1a; border:6px solid var(--ink);
      box-shadow: 0 5px 0 #000, inset 0 0 10px rgba(0,0,0,.4);
      overflow:hidden;
    }
    .lifeFill{
      position:absolute; left:0; top:0; bottom:0; width:100%;
      background: linear-gradient(90deg, #ff6b6b, #ff3b3b);
      box-shadow: inset 0 -4px 0 rgba(0,0,0,.25), 0 0 12px rgba(255,59,59,.35);
      transition: width .12s steps(4, end);
    }
    .lifeSeg{ position:absolute; top:0; bottom:0; width:10%; border-right:2px solid rgba(0,0,0,.35); pointer-events:none; }
    .lifeBar .lifeSeg:nth-child(1){ left:10% } .lifeBar .lifeSeg:nth-child(2){ left:20% }
    .lifeBar .lifeSeg:nth-child(3){ left:30% } .lifeBar .lifeSeg:nth-child(4){ left:40% }
    .lifeBar .lifeSeg:nth-child(5){ left:50% } .lifeBar .lifeSeg:nth-child(6){ left:60% }
    .lifeBar .lifeSeg:nth-child(7){ left:70% } .lifeBar .lifeSeg:nth-child(8){ left:80% }
    .lifeBar .lifeSeg:nth-child(9){ left:90% }

    /* 게임 필드 */
    #game{
      position:relative; width:100%; height:560px; margin:12px auto 0;
      background: repeating-linear-gradient(90deg, #182136 0 2px, #1e2a42 2px 6px);
      border:8px solid var(--ink); outline:4px solid #0c1322;
      box-shadow: inset 0 0 40px rgba(0,0,0,.65), 0 0 12px var(--accent), 0 0 30px rgba(0,255,195,.35);
      overflow:hidden; animation: neonPulse 2400ms ease-in-out infinite;
    }
    @keyframes neonPulse{
      0%,100%{ box-shadow: inset 0 0 40px rgba(0,0,0,.65), 0 0 10px var(--accent), 0 0 24px rgba(0,255,195,.3) }
      50%{    box-shadow: inset 0 0 40px rgba(0,0,0,.65), 0 0 18px var(--accent), 0 0 40px rgba(0,255,195,.5) }
    }

    .word{
      position:absolute; font-size:20px; line-height:1; color:#eafff9;
      background:#0f2530; border:4px solid var(--ink); padding:8px 12px;
      box-shadow: 0 4px 0 #000, 0 0 10px rgba(0,255,195,.25);
      user-select:none; pointer-events:none;
    }

    #controls{ margin:14px 0 20px }
    #input{
      width:480px; max-width:92%; padding:16px 18px; font-size:18px;
      color:#09221c; background:var(--accent); border:6px solid var(--ink);
      box-shadow: 0 6px 0 #004437, inset 0 -6px 0 rgba(0,0,0,.15); outline:none;
    }
    #input:disabled{ filter:grayscale(.6) brightness(.85) }
    .btn{
      display:inline-flex; align-items:center; gap:10px; margin-left:12px; padding:16px 20px; font-size:18px;
      color:#09221c; background:var(--accent); border:6px solid var(--ink); cursor:pointer;
      box-shadow: 0 6px 0 #004437, 0 0 16px rgba(0,255,195,.25); transition: transform .05s;
    }
    .btn:hover{ filter:brightness(.95) }
    .btn:active{ transform: translateY(2px); box-shadow: 0 3px 0 #004437 }
    #restartBtn{ display:none }

    /* 인게임 응원 코멘트 (UI/그래픽 동일, display 토글 → opacity 토글) */
    #announcer{
      position:absolute; left:50%; transform:translateX(-50%) translateZ(0);
      top:14px; z-index:8; pointer-events:none;
      max-width:92%; padding:8px 12px; font-size:16px;
      color:#aefbe7; text-shadow:0 2px 0 #001b16;
      background: rgba(15,37,48, .65);
      border:4px solid var(--ink);
      box-shadow:0 4px 0 #000, 0 0 12px rgba(0,255,195,.25);

      opacity:0;                 /* ← 기본은 보이지 않음 */
      transition: opacity .18s ease-out;
      will-change: opacity, transform;
      backface-visibility: hidden;
    }

    /* 오버레이/미스/인서트코인 */
    #overlay, #missFlash, #insertCoin{ position:absolute; inset:0; display:none; align-items:center; justify-content:center; z-index:6; }
    #countdown{
      font-size:56px; color:#fff; text-shadow: 0 3px 0 var(--ink), 0 0 18px rgba(255,212,0,.6);
      animation: pop .4s ease-out;
    }
    @keyframes pop{ from{ transform:scale(.6); opacity:.2 } to{ transform:scale(1); opacity:1 } }

    #missFlash{ background: rgba(255,0,0,.22); pointer-events:none; }
    @keyframes missBlink{ 0%{opacity:0} 20%{opacity:1} 100%{opacity:0} }

    #insertCoin{
      flex-direction:column; gap:12px; color:#ffeaa7;
      text-shadow: 0 2px 0 var(--ink), 0 0 10px rgba(255,234,167,.6);
      animation: coinBlink 1s steps(2,end) infinite;
    }
    #insertCoin .small{ font-size:14px; color:#b9c8ff; text-shadow:none }
    @keyframes coinBlink{ 0%{opacity:1} 50%{opacity:.15} 100%{opacity:1} }

    .float-score{
      position:absolute; transform:translate(-50%, -50%); pointer-events:none; font-size:18px; color:#fff;
      text-shadow:0 2px 0 var(--ink), 0 0 10px rgba(255,212,0,.7); animation: rise 700ms ease-out forwards; z-index:7;
    }
    @keyframes rise{ from{ opacity:0; transform:translate(-50%,-10%) } 20%{ opacity:1 } to{ opacity:0; transform:translate(-50%,-80%) } }

    /* 결과(등급/축하) 오버레이 */
    #resultOverlay{
      position:fixed; inset:0; background: rgba(0,0,0,.65);
      display:none; align-items:center; justify-content:center; z-index:20;
    }
    .resultCard{
      background:#0d1b2a; border:6px solid var(--accent); padding:24px 28px;
      box-shadow: 0 10px 0 #000, 0 0 24px rgba(0,255,195,.35);
      width:min(620px, 92%); text-align:center;
      animation: pop .3s ease-out;
    }
    .gradeBadge{
      margin:0 auto 10px; width:92px; height:92px; border:6px solid #000; border-radius:14px;
      display:flex; align-items:center; justify-content:center; font-size:46px; color:#101018;
      box-shadow: 0 6px 0 #000, 0 0 18px rgba(255,255,255,.25);
      text-shadow: 0 3px 0 rgba(0,0,0,.3);
    }
    .gradeS{ background: var(--gold); }
    .gradeA{ background: var(--green); }
    .gradeB{ background: var(--silver); }
    .gradeC{ background: var(--gray); color:#0a0f18; }
    .resultTitle{ font-size:26px; color:#ffd400; text-shadow:0 3px 0 #000, 0 0 18px rgba(255,212,0,.5); margin-bottom:6px; }
    .resultScore{ font-size:22px; margin:6px 0 2px; color:#aefbe7 }
    .resultSub{ font-size:16px; color:#cfe4ff; margin-bottom:10px }
    .resultTitle2{ font-size:18px; margin:8px 0 12px; color:#ffeaa7 }
    .resultBtns{ margin-top:12px }
    .resultBtns .btn{ margin:8px }

    .confetti{
      position:fixed; top:-10px; width:8px; height:8px; background:#ffd400;
      animation: fall 1600ms linear forwards; z-index:21;
      box-shadow: 0 0 10px rgba(255,255,255,.4);
    }
    @keyframes fall{ to{ transform:translateY(110vh) rotate(540deg); } }
  </style>
</head>
<body>
  <h1>본격 어색함 방지 게임 : 너의 이름은</h1>

  <!-- HUD -->
  <div id="hud">
    <div class="hud-item" id="timer">
      <svg class="icon" viewBox="0 0 16 16" shape-rendering="crispEdges">
        <rect width="16" height="16" fill="none"/>
        <rect x="6" y="0" width="4" height="2" fill="#000"/>
        <rect x="5" y="2" width="6" height="2" fill="#000"/>
        <rect x="3" y="4" width="10" height="10" fill="#ffd400" stroke="#000" stroke-width="2"/>
        <rect x="7" y="6" width="2" height="4" fill="#000"/>
      </svg>
      <div>TIME<br>남은 시간: <b>60</b>s</div>
    </div>

    <div class="hud-item" id="score">
      <svg class="icon" viewBox="0 0 16 16" shape-rendering="crispEdges">
        <rect width="16" height="16" fill="none"/>
        <rect x="3" y="1" width="10" height="4" fill="#ffd400" stroke="#000" stroke-width="2"/>
        <rect x="2" y="3" width="3" height="4" fill="#ffd400" stroke="#000" stroke-width="2"/>
        <rect x="11" y="3" width="3" height="4" fill="#ffd400" stroke="#000" stroke-width="2"/>
        <rect x="6" y="5" width="4" height="5" fill="#ffd400" stroke="#000" stroke-width="2"/>
        <rect x="5" y="10" width="6" height="2" fill="#ffd400" stroke="#000" stroke-width="2"/>
        <rect x="4" y="12" width="8" height="2" fill="#ffd400" stroke="#000" stroke-width="2"/>
      </svg>
      <div>SCORE<br>점수: <b>0</b></div>
    </div>

    <div class="hud-item" id="combo">
      <svg class="icon" viewBox="0 0 16 16" shape-rendering="crispEdges">
        <rect width="16" height="16" fill="none"/>
        <polygon points="7,0 2,9 6,9 3,16 13,6 9,6 12,0" fill="#ff9bd3" stroke="#000" stroke-width="2"/>
      </svg>
      <div>COMBO<br>연속: <b id="comboCount">0</b> ×<b id="mult">1</b></div>
    </div>

    <div class="hud-item" id="life">
      <svg class="icon" viewBox="0 0 16 16" shape-rendering="crispEdges">
        <rect width="16" height="16" fill="none"/>
        <path d="M8 14 L2 8 C-1 5 2 1 5 3 C6 4 7 5 8 6 C9 5 10 4 11 3 C14 1 17 5 14 8 Z"
              fill="#ff5b7f" stroke="#000" stroke-width="2"/>
      </svg>
      <div id="lifeBox">
        <div id="lifeText">LIFE: <b>10</b>/10</div>
        <div class="lifeBar">
          <div class="lifeFill" id="lifeFill" style="width:100%"></div>
          <div class="lifeSeg"></div><div class="lifeSeg"></div><div class="lifeSeg"></div>
          <div class="lifeSeg"></div><div class="lifeSeg"></div><div class="lifeSeg"></div>
          <div class="lifeSeg"></div><div class="lifeSeg"></div><div class="lifeSeg"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- 게임 필드 -->
  <div id="game">
    <!-- 인게임 응원 코멘트 (opacity로만 토글) -->
    <div id="announcer">👏 멘트</div>

    <div id="overlay"><div id="countdown">READY</div></div>
    <div id="missFlash"></div>
    <div id="insertCoin">
      <div>INSERT COIN</div>
      <div class="small">[게임 시작] 버튼을 눌러 주세요</div>
    </div>
  </div>

  <!-- 컨트롤 -->
  <div id="controls">
    <input type="text" id="input" placeholder="이름을 입력하고 Enter" autocomplete="off" disabled />
    <button id="startBtn" class="btn">
      <svg class="icon" viewBox="0 0 16 16" shape-rendering="crispEdges">
        <polygon points="3,2 13,8 3,14" fill="#003a31" stroke="#001b16" stroke-width="2"/>
      </svg>
      게임 시작
    </button>
    <button id="restartBtn" class="btn">
      <svg class="icon" viewBox="0 0 16 16" shape-rendering="crispEdges">
        <polyline points="2,6 2,2 6,2" fill="none" stroke="#001b16" stroke-width="3"/>
        <polyline points="14,10 14,14 10,14" fill="none" stroke="#001b16" stroke-width="3"/>
        <polyline points="6,2 14,10" fill="none" stroke="#001b16" stroke-width="3"/>
        <polyline points="10,14 2,6" fill="none" stroke="#001b16" stroke-width="3"/>
      </svg>
      재시작
    </button>
  </div>

  <!-- 결과(등급/축하) 오버레이 -->
  <div id="resultOverlay">
    <div class="resultCard">
      <div id="gradeBadge" class="gradeBadge gradeC">C</div>
      <div class="resultTitle" id="resultTitle">🎉 GREAT JOB! 🎉</div>
      <div class="resultTitle2" id="gradeTitle">조원들 이름은... 아시죠? 😅</div>
      <div class="resultScore">최종 점수: <b id="finalScore">0</b></div>
      <div class="resultSub">
        <span id="finalComment">이 정도면 이름 거의 외울 듯? 대단해요!</span>
        <br>
        Max Combo: <b id="finalCombo">0</b>
      </div>
      <div class="resultBtns">
        <button id="playAgain" class="btn">다시 하기</button>
      </div>
    </div>
  </div>

  <script>
    /* ===== 등급/칭호 기준 ===== */
    const GRADE_THRESHOLDS = { S:150, A:100, B:60 };
    const GRADE_TITLES = {
      S: "HR Day의 정.복.자🥰",
      A: "HR Day 참석 준비 완료🔥",
      B: "이 정도면 서로 인사는 가능!",
      C: "조원들 이름은... 아시죠? 😅"
    };

    // === 이름 83개 ===
    const words = [
      "남궁명","이윤서","권영지","기잎새","채유라","김병규","박성진","이상훈","권정연",
      "장서윤","조민하","이건일","조영진","이하지","이민지","안수현","김성훈","이지은",
      "류한나","방웅빈","김혜미","허기무","추현일","한지호","김가람","정민준","한윤서",
      "김소영","임동현","김현주","이은경","임동선","금상훈","정다미","김민주","이현영",
      "박서준","조경민","문상하","배준호","김수현","김태리","유원녕","박영현","전현태",
      "백진현","홍석란","김소현","장병국","신승훈","김지수","장혁민","곽영재","김형준",
      "최고은","윤성은","최서영","문수영","김수현","이선우","장해원","임용재","최지수",
      "임정은","박진수","문진영","이혜미","고광남","정우진","정대훈","곽규환","이예은",
      "백은정","이정하","현채빈","김서연","이중엽","윤상빈","이지영","김선진","현동윤",
      "김다혜","최민아"
    ];

    /* ===== 중복 방지 셔플 풀 ===== */
    let wordPool = shuffle([...words]);
    function shuffle(arr){
      for(let i=arr.length-1; i>0; i--){
        const j=Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }
    function getNextWord(){
      if(wordPool.length===0) wordPool = shuffle([...words]);
      return wordPool.pop();
    }

    /* ===== 효과음: 히트/미스만 유지 ===== */
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    let actx = null;
    function ensureAudio(){ if(!actx) actx = new AudioCtx(); }
    function beep({freq=880, type='square', duration=0.08, gain=0.05}={}){
      ensureAudio();
      const osc = actx.createOscillator();
      const g = actx.createGain();
      osc.type = type; osc.frequency.value = freq;
      g.gain.value = gain;
      osc.connect(g).connect(actx.destination);
      osc.start();
      setTimeout(()=>{ osc.stop(); osc.disconnect(); g.disconnect(); }, duration*1000);
    }
    function chord(freqs = [880, 1320, 1760], duration = 0.14, gainVal = 0.06){
      ensureAudio();
      const g = actx.createGain(); g.gain.value = gainVal; g.connect(actx.destination);
      const oscs = freqs.map(f=>{
        const o = actx.createOscillator();
        o.type = 'square'; o.frequency.value = f; o.connect(g); o.start();
        return o;
      });
      setTimeout(()=>{
        oscs.forEach(o=>o.stop()); oscs.forEach(o=>o.disconnect()); g.disconnect();
      }, duration*1000);
    }
    function hitSound(){ beep({freq: 880, type:'square', duration:0.07, gain:0.06}); setTimeout(()=>beep({freq: 1320, type:'square', duration:0.05, gain:0.05}), 60); }
    function missSound(){
      ensureAudio();
      const o1 = actx.createOscillator(), n = actx.createOscillator(), g = actx.createGain();
      o1.type='square'; o1.frequency.value=110; n.type='triangle'; n.frequency.value=55; g.gain.value=0.07;
      o1.connect(g); n.connect(g); g.connect(actx.destination); o1.start(); n.start();
      setTimeout(()=>{ o1.stop(); n.stop(); o1.disconnect(); n.disconnect(); g.disconnect(); }, 110);
    }

    /* ===== 점수 구간 멘트 (인게임 배너, opacity 토글) ===== */
    const MILESTONES = [
      {score: 10,  msg: "워밍업 완료! 손 풀렸어요 🔥"},
      {score: 30,  msg: "리듬 탔다! 좋아요 🎶"},
      {score: 50,  msg: "이 정도면 이름 거의 외울 듯? 대단해요! 💪"},
      {score: 80,  msg: "폭주 시작! 멈출 수 없다 🚀"},
      {score: 100, msg: "백점 돌파! 전설의 시작 👑"},
      {score: 150, msg: "괴물 손가락 등장… 🧟‍♂️"},
    ];
    const shownMilestones = new Set();

    const BONUS_NAMES = new Map([
      ["김태리", 5],
      ["박서준", 5],
    ]);

    // 렉 최적화: display 토글 없이 opacity로만 표시/숨김
    function showAnnouncer(text){
      const el = document.getElementById("announcer");
      el.textContent = text;
      el.style.opacity = 1;            // 보이기
      clearTimeout(el._t);
      el._t = setTimeout(()=>{ el.style.opacity = 0; }, 1600); // 일정 시간 후 숨김
    }
    function checkMilestones(currentScore){
      for(const m of MILESTONES){
        if(currentScore >= m.score && !shownMilestones.has(m.score)){
          shownMilestones.add(m.score);
          showAnnouncer(m.msg); // (효과음 없음)
        }
      }
    }

    // Elements
    const gameArea = document.getElementById("game");
    const input = document.getElementById("input");
    const scoreB = document.querySelector("#score b");
    const timerB = document.querySelector("#timer b");
    const comboCountB = document.getElementById("comboCount");
    const multB = document.getElementById("mult");
    const startBtn = document.getElementById("startBtn");
    const restartBtn = document.getElementById("restartBtn");
    const overlay = document.getElementById("overlay");
    const countdownEl = document.getElementById("countdown");
    const missFlash = document.getElementById("missFlash");
    const insertCoin = document.getElementById("insertCoin");
    const lifeFill = document.getElementById("lifeFill");
    const lifeText = document.getElementById("lifeText");

    const resultOverlay = document.getElementById("resultOverlay");
    const finalScoreEl = document.getElementById("finalScore");
    const finalComboEl = document.getElementById("finalCombo");
    const finalCommentEl = document.getElementById("finalComment");
    const resultTitleEl = document.getElementById("resultTitle");
    const gradeBadgeEl = document.getElementById("gradeBadge");
    const gradeTitleEl = document.getElementById("gradeTitle");
    const playAgainBtn = document.getElementById("playAgain");

    // State
    let score = 0;
    let fallSpeed = 2.2;
    let spawnMs = 900;
    let timeLeft = 60;
    let combo = 0;
    let multiplier = 1;
    let maxCombo = 0;
    let isRunning = false;
    let lastMissTime = 0;

    const MAX_LIFE = 10;
    let life = MAX_LIFE;

    let gameInterval=null, wordInterval=null, timerInterval=null, speedInterval=null, countdownTimer=null;

    function clearAllIntervals(){
      [gameInterval,wordInterval,timerInterval,speedInterval,countdownTimer].forEach(t=>t && clearInterval(t));
      gameInterval=wordInterval=timerInterval=speedInterval=countdownTimer=null;
    }

    function updateLifeBar(){
      const pct = Math.max(0, Math.min(1, life / MAX_LIFE));
      lifeFill.style.width = (pct*100) + "%";
      lifeText.innerHTML = `LIFE: <b>${life}</b>/${MAX_LIFE}`;
      if(pct <= 0.3){ lifeFill.style.filter = "saturate(1.4) brightness(1)"; }
      else if(pct <= 0.6){ lifeFill.style.filter = "saturate(1.2)"; }
      else { lifeFill.style.filter = "none"; }
    }

    function resetState(){
      score=0; fallSpeed=2.2; spawnMs=900; timeLeft=60; combo=0; multiplier=1; maxCombo=0; isRunning=false;
      life = MAX_LIFE; updateLifeBar();
      shownMilestones.clear();

      scoreB.textContent=score; timerB.textContent=timeLeft;
      comboCountB.textContent=combo; multB.textContent=multiplier;
      restartBtn.style.display="none"; startBtn.style.display="inline-flex";
      input.value=""; input.disabled=true;
      document.querySelectorAll(".word").forEach(el=>el.remove());
      overlay.style.display="none";
      missFlash.style.display="none"; missFlash.style.animation="none";
      insertCoin.style.display="flex";
      wordPool = shuffle([...words]);
      document.getElementById("announcer").style.opacity = 0;   // display 조작 금지
      resultOverlay.style.display="none";
      document.querySelectorAll(".confetti").forEach(c=>c.remove());
    }

    function createWord(){
      const wordEl=document.createElement("div");
      wordEl.className="word";
      wordEl.textContent=getNextWord();
      const maxLeft=Math.max(0, gameArea.clientWidth - 200);
      wordEl.style.left=Math.max(0, Math.random()*maxLeft) + "px";
      wordEl.style.top="0px";
      gameArea.appendChild(wordEl);
    }

    function moveWords(){
      const wordEls=document.querySelectorAll(".word");
      wordEls.forEach(word=>{
        let top=parseFloat(word.style.top);
        top += fallSpeed;
        word.style.top=top+"px";
        if(top>gameArea.clientHeight){
          word.remove();
          registerMiss();
        }
      });
    }

    function updateCombo(hit){
      if(hit){ combo++; if(combo>maxCombo) maxCombo=combo; multiplier = Math.min(1 + Math.floor(combo/5), 5); }
      else { combo = 0; multiplier = 1; }
      comboCountB.textContent = combo; multB.textContent = multiplier;
    }

    function floatScore(x,y,amount, colorText="#fff"){
      const el=document.createElement("div");
      el.className="float-score"; el.style.left = x+"px"; el.style.top = y+"px";
      el.style.color = colorText;
      el.textContent = `+${amount}`;
      gameArea.appendChild(el);
      setTimeout(()=>el.remove(),700);
    }

    function actuallyStartGame(){
      isRunning=true; input.disabled=false; input.focus();
      wordInterval = setInterval(createWord, spawnMs);
      gameInterval = setInterval(moveWords, 30);
      speedInterval = setInterval(()=>{ fallSpeed += 0.35; }, 4000);
      timerInterval = setInterval(()=>{
        timeLeft--; timerB.textContent=timeLeft;
        if(timeLeft<=0) endGame("time");
      },1000);
    }

    // 첫 멘트 렌더 워밍업 (시각 변화 없음)
    function warmUpAnnouncer(){
      const el = document.getElementById("announcer");
      const prev = el.textContent;
      el.textContent = " ";
      el.style.opacity = 0.0001;
      requestAnimationFrame(()=>requestAnimationFrame(()=>{
        el.style.opacity = 0;
        el.textContent = prev;
      }));
    }

    function startWithCountdown(){
      clearAllIntervals(); resetState();
      startBtn.style.display="none";
      insertCoin.style.display="none";
      overlay.style.display="flex"; input.disabled=true;

      warmUpAnnouncer(); // ✅ 첫 표시 렉 방지

      const steps=["READY","3","2","1","GO!"]; let idx=0;
      countdownEl.textContent=steps[idx]; countdownEl.style.animation="pop .4s ease-out";
      countdownTimer=setInterval(()=>{
        idx++;
        if(idx<steps.length){
          countdownEl.textContent=steps[idx];
          countdownEl.style.animation="none"; void countdownEl.offsetWidth; countdownEl.style.animation="pop .4s ease-out";
        }else{
          clearInterval(countdownTimer);
          overlay.style.display="none";
          actuallyStartGame();
        }
      },800);
    }

    function getEndComment(s){
      if(s>=150) return "당신의 손가락은 전설입니다! 👑";
      if(s>=100) return "백점 돌파! 모두가 이름 부를 때 당신을 찾습니다 😎";
      if(s>=80)  return "폭주 드리프트!! 완전 잘했어요 🚀";
      if(s>=50)  return "이제 진짜 외워버렸다! 💪";
      if(s>=30)  return "리듬 제대로 탔다 🎶";
      return "워밍업 굿! 다음 라운드 고고 🔥";
    }

    function spawnConfetti(n=40){
      const colors = ["#ffd400","#00ffc3","#ff5b5b","#ff9bd3","#47b0ff","#ffffff"];
      for(let i=0;i<n;i++){
        const c = document.createElement("div");
        c.className = "confetti";
        c.style.left = (Math.random()*100) + "vw";
        c.style.background = colors[Math.floor(Math.random()*colors.length)];
        c.style.animationDuration = (1200 + Math.random()*900) + "ms";
        c.style.transform = `translateY(-10px) rotate(${Math.random()*360}deg)`;
        document.body.appendChild(c);
        setTimeout(()=>c.remove(), 2000);
      }
    }

    function getGrade(score){
      if(score >= GRADE_THRESHOLDS.S) return "S";
      if(score >= GRADE_THRESHOLDS.A) return "A";
      if(score >= GRADE_THRESHOLDS.B) return "B";
      return "C";
    }

    function applyGradeUI(grade){
      gradeBadgeEl.textContent = grade;
      gradeBadgeEl.classList.remove("gradeS","gradeA","gradeB","gradeC");
      gradeBadgeEl.classList.add(grade==="S"?"gradeS":grade==="A"?"gradeA":grade==="B"?"gradeB":"gradeC");
      gradeTitleEl.textContent = GRADE_TITLES[grade] || "";
    }

    function endGame(reason="time"){
      isRunning=false; clearAllIntervals(); input.disabled=true;
      restartBtn.style.display="inline-flex";

      const grade = getGrade(score);
      applyGradeUI(grade);

      finalScoreEl.textContent = score;
      finalComboEl.textContent = maxCombo;
      finalCommentEl.textContent = getEndComment(score);
      resultTitleEl.textContent = reason === "life" ? "💔 GAME OVER" : "🎉 GREAT JOB!";
      resultOverlay.style.display = "flex";

      // 축하 사운드/콘페티 (원하면 비활성화 가능)
      if(reason!=="life"){
        if(grade==="S" || grade==="A"){
          chord([660,990,1320], 0.24, 0.075);
          setTimeout(()=>beep({freq:1760, duration:0.06, gain:0.07}), 120);
          spawnConfetti(80);
        }else{
          chord([520,780,1040], 0.18, 0.06);
          spawnConfetti(40);
        }
      }else{
        missSound();
      }
    }

    function triggerMissFlash(){
      const now=Date.now(); if(now - lastMissTime < 150) return; lastMissTime = now;
      missFlash.style.display="block";
      missFlash.style.animation="none"; void missFlash.offsetWidth;
      missFlash.style.animation="missBlink 280ms ease-out";
      setTimeout(()=>{ missFlash.style.display="none"; },280);
    }

    function registerMiss(){
      updateCombo(false);
      life = Math.max(0, life-1);
      updateLifeBar();
      triggerMissFlash();
      missSound();
      if(life<=0){ endGame("life"); }
    }

    // 입력
    input.addEventListener("keydown",(e)=>{
      if(e.key==="Enter" && isRunning){
        const value=input.value.trim();
        if(!value) return;

        const wordEls = Array.from(document.querySelectorAll(".word"))
          .filter(w=>w.textContent===value)
          .sort((a,b)=>parseFloat(a.style.top)-parseFloat(b.style.top));

        if(wordEls.length>0){
          const target=wordEls[0];
          const rect=target.getBoundingClientRect();
          const parentRect=gameArea.getBoundingClientRect();
          const cx=rect.left - parentRect.left + rect.width/2;
          const cy=rect.top - parentRect.top;

          target.remove();
          updateCombo(true);

          const baseGain = 1 * multiplier;
          let totalGain = baseGain;
          score += baseGain;
          floatScore(cx, cy, baseGain, "#fff");
          hitSound();

          // 보너스
          if(BONUS_NAMES.has(value)){
            const bonus = BONUS_NAMES.get(value) || 0;
            if(bonus > 0){
              score += bonus; totalGain += bonus;
              floatScore(cx, cy-24, bonus, "#ffd400");
              showAnnouncer(`✨ 신규입사자 보너스! +${bonus}`); // 인게임 배너로 표시
            }
          }

          scoreB.textContent = score;
          checkMilestones(score);

        }else{
          registerMiss();
        }
        input.value="";
      }
    });

    // 버튼
    startBtn.addEventListener("click", ()=>{ ensureAudio(); startWithCountdown(); });
    restartBtn.addEventListener("click", ()=>{ ensureAudio(); startWithCountdown(); });
    document.getElementById("playAgain").addEventListener("click", ()=>{ ensureAudio(); startWithCountdown(); });

    // 포커스 유지
    window.addEventListener("resize", ()=>{ if(isRunning) input.focus(); });

    // 초기 상태
    resetState();
  </script>
</body>
</html>
